<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ChildBotHost V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    .card { transition: box-shadow .2s ease-in-out; }
    .card:hover { box-shadow: 0 .5rem 1rem rgba(0,0,0,.15); }
    .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    .status-run { background-color: #198754; }
    .status-stop { background-color: #6c757d; }
  </style>
</head>
<body>
<div class="container py-5">
  <header class="d-flex justify-content-between align-items-center pb-3 mb-4 border-bottom">
    <h1 class="h3">ChildBotHost V2</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBotModal">
      + Create New Bot
    </button>
  </header>

  <main>
    <div id="botsGrid" class="row g-4">
      <!-- Bots will be loaded here -->
    </div>
  </main>
</div>

<!-- Create Bot Modal -->
<div class="modal fade" id="createBotModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Bot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="botName" class="form-label">Bot Name</label>
          <input type="text" class="form-control" id="botName" placeholder="My Awesome Bot">
        </div>
        <div class="mb-3">
          <label for="botToken" class="form-label">Bot Token</label>
          <input type="text" class="form-control" id="botToken" placeholder="From @BotFather">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="createBot()">Create Bot</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API = {
    post: (endpoint, body) => fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    }).then(res => res.json()),
    get: (endpoint) => fetch(endpoint).then(res => res.json()),
  };

  async function loadBots() {
    const bots = await API.get('/getBots');
    const grid = document.getElementById('botsGrid');
    grid.innerHTML = '';
    if (bots.length === 0) {
        grid.innerHTML = `<div class="col-12"><div class="card card-body text-center"><p class="mb-0 text-muted">No bots found. Click 'Create New Bot' to start!</p></div></div>`;
        return;
    }
    bots.forEach(bot => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.innerHTML = `
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">${bot.name}</h5>
              <span class="status-dot ${bot.status === 'RUN' ? 'status-run' : 'status-stop'}" title="${bot.status}"></span>
            </div>
            <button class="btn btn-sm ${bot.status === 'RUN' ? 'btn-warning' : 'btn-success'}" onclick="toggleBot('${bot.botId}')">
              ${bot.status === 'RUN' ? 'Stop' : 'Start'} Bot
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteBot('${bot.botId}')">Delete</button>
          </div>
        </div>
      `;
      grid.appendChild(col);
    });
  }

  async function createBot() {
    const name = document.getElementById('botName').value;
    const token = document.getElementById('botToken').value;
    if (!name || !token) return alert('Please provide both name and token.');

    const result = await API.post('/createBot', { name, token });
    if (result.ok) {
      bootstrap.Modal.getInstance(document.getElementById('createBotModal')).hide();
      document.getElementById('botName').value = '';
      document.getElementById('botToken').value = '';
      loadBots();
    } else {
      alert(`Error: ${result.message}`);
    }
  }

  async function toggleBot(botId) {
    await API.post('/toggleBot', { botId });
    loadBots();
  }

  async function deleteBot(botId) {
    if (confirm('Are you sure you want to delete this bot?')) {
      await API.post('/deleteBot', { botId });
      loadBots();
    }
  }

  // Initial load
  document.addEventListener('DOMContentLoaded', loadBots);
</script>
</body>
</html>      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Bot</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input id="newToken" class="form-control mb-3" placeholder="Bot Token">
          <input id="newName" class="form-control mb-3" placeholder="Bot Name">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createBot()">Create Bot</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast-container">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i data-lucide="check-circle" class="me-2"></i>
          <span id="toastMessage">Operation successful</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bots Dashboard -->
  <div id="dashboardSection">
    <h4 class="mb-3">Your Bots</h4>
    <div id="botsGrid" class="row g-3"></div>
  </div>

  <!-- Commands Dashboard -->
  <div id="commandsSection" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <button class="btn btn-outline-secondary btn-lucide" onclick="closeCommands()">
        <i data-lucide="arrow-left"></i>Back to Dashboard
      </button>
      <h4 class="mb-0">Commands for <span id="cmdBotName" class="badge bg-primary"></span></h4>
      <div></div> <!-- Empty div for flex spacing -->
    </div>

    <!-- Command Edit Section -->
    <div id="commandEditSection" class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span id="editSectionTitle">Add New Command</span>
        <button id="cancelEditBtn" class="btn btn-sm btn-outline-secondary" style="display:none" onclick="cancelEdit()">
          <i data-lucide="x" class="me-1"></i>Cancel
        </button>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Command name (without /)</label>
          <input id="cmdName" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Command code</label>
          <textarea id="cmdCode" class="form-control" rows="6" placeholder="ctx.reply('Hello');"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveCommand()">
          <i data-lucide="save" class="me-1"></i>Save Command
        </button>
      </div>
    </div>

    <!-- Command List -->
    <h5 class="mb-3">Existing Commands</h5>
    <div id="cmdGrid" class="row g-3"></div>
  </div>
</main>

<footer>
  <div>© <span id="year"></span> ChildBotHost – Open Source Telegram Bot Platform Server. Developed with ❤️ by ChildCoder</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script>
// Initialize
lucide.createIcons();
document.getElementById('year').innerText = new Date().getFullYear();
const toast = new bootstrap.Toast(document.getElementById('successToast'));
let currentBotId = null;
let editingCommand = null;

// API helper
const api = (p,d) => fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).then(r=>r.json());

/* ---------- Toast Notifications ---------- */
function showToast(message) {
  document.getElementById('toastMessage').innerText = message;
  toast.show();
}

/* ---------- Bots Management ---------- */
async function loadBots() {
  try {
    const list = await fetch('/getBots').then(r=>r.json());
    const grid = document.getElementById('botsGrid');
    grid.innerHTML = '';
    
    if (list.length === 0) {
      grid.innerHTML = `
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-4">
              <i data-lucide="bot" class="text-muted mb-2" width="48" height="48"></i>
              <h5 class="text-muted">No bots created yet</h5>
              <p class="text-muted mb-0">Click "Create New Bot" to get started</p>
            </div>
          </div>
        </div>`;
      return;
    }

    list.forEach(b => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.innerHTML = `
        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <span>${b.name}</span>
            <span class="badge ${b.status==='RUN'?'bg-success':'bg-secondary'}">${b.status}</span>
          </div>
          <div class="card-body">
            <button class="btn btn-sm ${b.status==='RUN'?'btn-warning':'btn-success'} me-1" onclick="toggleBot('${b.botId}')">
              <i data-lucide="${b.status==='RUN'?'power-off':'play'}" class="me-1"></i>${b.status==='RUN'?'Stop':'Start'}
            </button>
            <button class="btn btn-sm btn-outline-info me-1" onclick="openCommands('${b.botId}','${b.name}')">
              <i data-lucide="terminal-square" class="me-1"></i>Commands
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteBot('${b.botId}')">
              <i data-lucide="trash-2" class="me-1"></i>Delete
            </button>
          </div>
        </div>`;
      grid.appendChild(col);
    });
    lucide.createIcons();
  } catch (error) {
    console.error('Error loading bots:', error);
    showToast('Error loading bots');
  }
}

async function createBot() {
  const token = document.getElementById('newToken').value.trim();
  const name = document.getElementById('newName').value.trim();
  
  if (!token || !name) {
    showToast('Please fill both fields');
    return;
  }

  try {
    await api('/createBot', {token, name});
    document.getElementById('newToken').value = '';
    document.getElementById('newName').value = '';
    bootstrap.Modal.getInstance(document.getElementById('createBotModal')).hide();
    showToast('Bot created successfully!');
    loadBots();
  } catch (error) {
    console.error('Error creating bot:', error);
    showToast('Error creating bot');
  }
}

async function toggleBot(id) {
  try {
    const bot = await fetch('/getBots').then(r=>r.json()).then(l=>l.find(b=>b.botId===id));
    const url = bot.status==='RUN'?'/stopBot':'/startBot';
    await api(url, {botId: id});
    showToast(`Bot ${bot.status==='RUN'?'stopped':'started'} successfully`);
    loadBots();
  } catch (error) {
    console.error('Error toggling bot:', error);
    showToast('Error toggling bot');
  }
}

async function deleteBot(id) {
  if (!confirm('Are you sure you want to delete this bot?')) return;
  
  try {
    await api('/deleteBot', {botId: id});
    showToast('Bot deleted successfully');
    loadBots();
  } catch (error) {
    console.error('Error deleting bot:', error);
    showToast('Error deleting bot');
  }
}

/* ---------- Commands Management ---------- */
async function openCommands(botId, name) {
  currentBotId = botId;
  document.getElementById('cmdBotName').innerText = name;
  document.getElementById('dashboardSection').style.display = 'none';
  document.getElementById('commandsSection').style.display = 'block';
  
  // Reset edit section
  document.getElementById('cmdName').value = '';
  document.getElementById('cmdCode').value = '';
  document.getElementById('editSectionTitle').innerText = 'Add New Command';
  document.getElementById('cancelEditBtn').style.display = 'none';
  editingCommand = null;
  
  await loadCommands();
}

function closeCommands() {
  document.getElementById('commandsSection').style.display = 'none';
  document.getElementById('dashboardSection').style.display = 'block';
}

async function loadCommands() {
  try {
    const cmds = await fetch(`/getCommands?botId=${currentBotId}`).then(r=>r.json());
    const grid = document.getElementById('cmdGrid');
    grid.innerHTML = '';
    
    if (Object.keys(cmds).length === 0) {
      grid.innerHTML = `
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-4">
              <i data-lucide="terminal-square" class="text-muted mb-2" width="48" height="48"></i>
              <h5 class="text-muted">No commands yet</h5>
              <p class="text-muted mb-0">Add your first command above</p>
            </div>
          </div>
        </div>`;
      return;
    }

    Object.entries(cmds).forEach(([name, code]) => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.innerHTML = `
        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <span>/${name}</span>
            <div>
              <button class="btn btn-sm btn-outline-secondary" onclick="editCmd('${name}',\`${escapeHtml(code)}\`)">
                <i data-lucide="edit-2" class="me-1"></i>Edit
              </button>
              <button class="btn btn-sm btn-outline-danger ms-1" onclick="delCmd('${name}')">
                <i data-lucide="trash-2" class="me-1"></i>Delete
              </button>
            </div>
          </div>
          <div class="card-body">
            <pre class="small bg-light p-2 rounded" style="max-height:120px;overflow:auto">${escapeHtml(code)}</pre>
          </div>
        </div>`;
      grid.appendChild(col);
    });
    lucide.createIcons();
  } catch (error) {
    console.error('Error loading commands:', error);
    showToast('Error loading commands');
  }
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function editCmd(name, code) {
  editingCommand = name;
  document.getElementById('cmdName').value = name;
  document.getElementById('cmdCode').value = code;
  document.getElementById('editSectionTitle').innerText = `Edit Command /${name}`;
  document.getElementById('cancelEditBtn').style.display = 'block';
  
  // Scroll to edit section
  document.getElementById('commandEditSection').scrollIntoView({ behavior: 'smooth' });
}

function cancelEdit() {
  editingCommand = null;
  document.getElementById('cmdName').value = '';
  document.getElementById('cmdCode').value = '';
  document.getElementById('editSectionTitle').innerText = 'Add New Command';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

async function saveCommand() {
  const name = document.getElementById('cmdName').value.trim();
  const code = document.getElementById('cmdCode').value.trim();
  
  if (!name || !code) {
    showToast('Please fill both fields');
    return;
  }

  try {
    if (editingCommand) {
      // If editing existing command, we might need to delete old one first if name changed
      if (name !== editingCommand) {
        await api('/delCommand', {botId: currentBotId, name: editingCommand});
      }
    }
    
    await api('/addCommand', {botId: currentBotId, name, code});
    showToast(`Command /${name} ${editingCommand ? 'updated' : 'added'} successfully`);
    
    // Reset form
    document.getElementById('cmdName').value = '';
    document.getElementById('cmdCode').value = '';
    document.getElementById('editSectionTitle').innerText = 'Add New Command';
    document.getElementById('cancelEditBtn').style.display = 'none';
    editingCommand = null;
    
    // Refresh command list
    await loadCommands();
  } catch (error) {
    console.error('Error saving command:', error);
    showToast('Error saving command');
  }
}

async function delCmd(name) {
  if (!confirm(`Are you sure you want to delete command /${name}?`)) return;
  
  try {
    await api('/delCommand', {botId: currentBotId, name});
    showToast(`Command /${name} deleted successfully`);
    
    // If we were editing this command, cancel edit
    if (editingCommand === name) {
      cancelEdit();
    }
    
    await loadCommands();
  } catch (error) {
    console.error('Error deleting command:', error);
    showToast('Error deleting command');
  }
}

// Initialize
loadBots();
</script>
</body>
  </html>
